<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.store.dao.StoreDao">
    <!--统计门店账号数量-->
    <select id="countStoreAcct" parameterType="com.store.entity.StoreInfo"
            resultType="int">
        select count(store_acct)
        from t_store
        where is_deleted = 0
        and store_acct = #{storeAcct}
        <if test="storeCode != null and storeCode != ''">
            and store_code != #{storeCode}
        </if>

    </select>

    <!--新增门店-->
    <insert id="addStore" parameterType="com.store.entity.StoreInfo">
        insert into t_store
        (store_code,
         store_acct,
         store_name,
         store_phone,
         boss_code,
         store_licence,
         province_id,
         city_id,
         district_id,
         store_address,
         is_deleted,
         create_user,
         create_time,
         update_time,
         last_modified_by,
         version)
        values
           (#{storeCode},
            #{storeAcct},
            #{storeName},
            #{storePhone},
            #{bossCode},
            #{storeLicence},
            #{provinceId},
            #{cityId},
            #{districtId},
            #{storeAddress},
            #{isDeleted},
            #{createBy},
            now(),
            now(),
            #{lastModifiedBy},
            0)
    </insert>

    <!--获取门店信息-->
    <select id="findStore" parameterType="com.store.entity.StoreInfo" resultType="com.store.entity.StoreInfo">
        select
        a.store_code storeCode,
        a.store_name storeName,
        a.store_phone storePhone,
        a.store_address storeAddress,
        a.boss_name bossName,
        a.store_invite_code storeInviteCode,
        a.store_acct storeAcct,
        a.province_id provinceId,
        a.city_id cityId,
        a.district_id districtId,
        a.is_deleted,
        a.create_user,
        a.create_time,
        a.update_time,
        a.last_modified_by,
        a.version
        from t_store a
        where a.store_code = #{storeCode}
        and is_deleted = 0
    </select>


    <!--门店列表-->
    <select id="listStore" parameterType="com.store.entity.StoreInfo" resultType="com.store.entity.StoreInfo">
        select
        a.store_code storeCode,
        a.store_name storeName,
        a.store_phone storePhone,
        a.store_address storeAddress,
        a.boss_name bossName,
        a.store_invite_code storeInviteCode,
        a.store_acct storeAcct
        from t_store a
        where a.is_deleted = 0
        <if test="storeCode != null and storeCode != ''">
            and a.store_Code like concat('%', #{storeCode}, '%')
        </if>
        <if test="storeName != null and storeName != ''">
            and a.store_name like concat('%', #{storeName}, '%')
        </if>
        <if test="bossName != null and bossName != ''">
            and a.boss_name like concat('%', #{bossName}, '%')
        </if>
        <if test="provinceId != null and provinceId != ''">
            and a.province_id like concat('%', #{provinceId}, '%')
        </if>
        <if test="cityId != null and cityId != ''">
            and a.city_id like concat('%', #{cityId}, '%')
        </if>
        <if test="districtId != null and districtId != ''">
            and a.district_id like concat('%', #{districtId}, '%')
        </if>
        order by a.create_user desc
    </select>

    <!--修改门店信息-->
    <update id="updateStore" parameterType="com.store.entity.StoreInfo">
        update t_store
        set
         store_name = #{storeName},
         store_phone = #{storePhone},
         store_address = #{storeAddress},
         boss_name = #{bossName},
         store_invite_code = #{storeInviteCode},
         store_acct = #{storeAcct},
         province_id = #{provinceId},
         city_id = #{cityId},
         district_id = #{districtId},
         store_licence = #{storeLicence},
         update_time = now(),
         last_modified_by  = #{lastModifiedBy},
         version = version + 1
         where store_code = #{storeCode}
          and version = #{version}
    </update>

    <!--删除门店-->
    <update id="deleteStore" parameterType="com.store.entity.StoreInfo">
        update t_store
        set
        is_deleted = 1,
        update_time = now(),
        last_modified_by   = #{userId},
        version = version + 1
        where store_code in
        <foreach item="storeCode" index="index" collection="listCode" open="(" separator="," close=")">
            #{storeCode}
        </foreach>
    </update>

</mapper>